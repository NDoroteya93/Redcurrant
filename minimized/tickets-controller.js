"use strict";import{loadTemplate}from"templates";import{TicketsModel}from"ticketsModel";import{UserModel}from"userModel";import{CategoryModel}from"categoryModel";import{Helpers}from"helpers";const LOCAL_STORAGE_USERNAME_KEY="signed-in-user-username",LOCAL_STORAGE_AUTHKEY_KEY="signed-in-user-auth-key";class TicketsController{constructor(){this._container=$("#container"),this._ticketModel=new TicketsModel,this._users=new UserModel,this._categories=new CategoryModel,this._helpers=new Helpers}get container(){return this._container}get ticketsModel(){return this._ticketModel}get helpers(){return this._helpers}get users(){return this._users}get categories(){return this._categories}ticketTemplate(){let b,a=this;new loadTemplate("tickets").getTemplate().then(a=>{b=this.ticketsModel.getTickets();return a}).then(c=>{setTimeout(function(){a.container.html(c(b)),a.initEvents()},500)})}initEvents(){let a=this;$(".edit-ticket").on("click",function(){let b=$(this),c=b.parents(".drag-container"),d=c.data("id");a.loadDetailsTemplate(d)}),$(".view-comments").on("click",function(){let b=$(this),c=b.parents(".drag-container"),d=c.data("id");a.loadDetailsTemplate(d)}),this.draggable(),$("#addTicketBtn").on("click",function(){let b=$("#ticket-title").val(),c=$("#ticket-description").val(),d=$("#select-priority option:selected").data("priority"),e=$("#select-category option:selected").data("id");a.ticketsModel.addTicket(b,c,d,e),$("#editТicket").modal("hide"),location.href="#/tickets"}),$(".btn-filter").on("click",function(){let a=$(this).data("state");"all"!==a?($(".table tbody tr").css("display","none"),$('.table tr[data-status="'+a+'"]').fadeIn("slow")):$(".table tbody tr").css("display","none").fadeIn("slow")}),$(".edit-icon-btn").on("click",function(){let a=$(this),b=a.parents("tr").data("id"),c=a.parents("tr").data("status");$("#update-ticket-btn").attr("data-id",b),$("#update-ticket-btn").attr("data-status",c),$("#edit").modal("show")}),$("#update-ticket-btn").on("click",function(){a.editTicket()}),$(".delete-icon-btn").on("click",function(){let a=$(this),b=a.parents("tr").data("id");$("#delete-ticket-btn").attr("data-id",b),$("#delete").modal("show")}),$("#delete-ticket-btn").on("click",function(){let b=$(this),c=b.attr("data-id");a.deteleTicket(c),a.allTickets(),$("#delete").modal("hide")}),jQuery(function(a){a("#editТicket").on("hidden.bs.modal",function(a){location.href="#/tickets"})}),$("#tickets-details-container").keypress(function(b){let c=$("#createNewComment").val(),d=$("#tickets-details-container").attr("data-id");13==b.which&&a.addComment(d,c)}),$("#sendComment").on("click",function(){let b=$("#createNewComment").val(),c=$("#tickets-details-container").attr("data-id");a.addComment(c,b)}),$("#showComment").on("click",function(){$("#container-comments").hasClass("hidden")?$("#container-comments").removeClass("hidden"):$("#container-comments").addClass("hidden")}),$(".changeAssignee").on("click",function(){let b=$(this),c=b.attr("data-id"),d=$("#tickets-details-container").attr("data-id"),e=b.text().trim();$(".tagAssignedUser").text("#"+e),$(".tagAssignedUser").attr("href",`#/user/${e}`),$("#dropdownMenu1").text(e),a.ticketsModel.assigneeUserToTask(d,c)}),$(".btn-state").on("click",function(){let b=$(this).data("state"),c=$(this).text().trim(),d=$("#tickets-details-container").attr("data-id");a.updateState(d,b),$(".tagStateUser").text("#"+c)}),$(".delete-comment-btn").on("click",function(){let b=$(this).parents(".panel-body").attr("data-comment");a.deleteComment(b),$(this).parents(".panel-body").remove()}),$(".hideComment").on("click",function(){$(this).parents(".panel-body").addClass("hidden")}),$(".shareFbBtn").on("click",function(a){a.preventDefault(),FB.ui({method:"share",href:"https://developers.facebook.com/docs/"},function(a){})})}draggable(){let a=!1,b=this;$(".dropConnect").disableSelection(),$("#draggable-todo").sortable({revert:"invalid",connectWith:".dropConnect",items:"div.drag-container",update:function(c,d){const e=d.item[0],f=$(e).data("id"),g=$(e).data("state"),h=$(e).parents(".nopadding").data("state");g!==h&&($(e).attr("data-state",h),b.updateState(f,h)),a=!d.sender},stop:function(b,c){a&&(a=!1)}}),$("#draggable-done").sortable({revert:"invalid",connectWith:".dropConnect",items:"div.drag-container",update:function(c,d){const e=d.item[0],f=$(e).data("id"),g=$(e).data("state"),h=$(e).parents(".nopadding").data("state");g!==h&&($(e).attr("data-state",h),b.updateState(f,h)),a=!d.sender},stop:function(b,c){a&&(a=!1)},receive:function(a,b){}}),$("#draggable-progress").sortable({revert:"invalid",connectWith:".dropConnect",items:"div.drag-container",update:function(c,d){const e=d.item[0],f=$(e).data("id"),g=$(e).data("state"),h=$(e).parents(".nopadding").data("state");g!==h&&($(e).attr("data-state",h),b.updateState(f,h)),a=!d.sender},stop:function(b,c){a&&(a=!1)}})}updateState(a,b){const c={taskState:b};this.ticketsModel.changeState(a,b,c)}loadDetailsTemplate(a){let c,b=this;const d=b.users.getUsers();new loadTemplate("tickets-details").getTemplate().then(b=>{c=this.ticketsModel.getTicketsDetails(a);c.users=d;console.log(c);return b}).then(a=>{setTimeout(function(){b.container.html(a(c)),b.initEvents(),$(".btn-state[data-state="+c.details.taskState+"]").addClass("active").prop("checked",!0)},1e3)})}addTicket(){let a=new loadTemplate("tickets-add"),b=this,c=this.categories.getCategories();a.getTemplate().then(a=>{setTimeout(function(){$('<div id="popupAdd"></div>').appendTo(b.container),$("#popupAdd").html(a(c)),$("#editТicket").modal("show")},500);b.initEvents()})}allTickets(){let b,a=this;const c=a.users.getUsers();this.helpers.priorityHelper(),new loadTemplate("tickets-all").getTemplate().then(a=>{b=this.ticketsModel.getTickets();b.users=c;return a}).then(c=>{setTimeout(function(){$("#alltickets").html(c(b)),a.initEvents()},500)})}editTicket(){let a=this,b=$("#update-ticket-btn").attr("data-id"),c=$("#update-ticket-btn").attr("data-status"),d=$("#user-edit-state option:selected").attr("data-state"),e=$("#edit-assignee option:selected").attr("data-user");c!==d&&($('.table tr[data-status="'+c+'"]').attr("data-status",d),a.updateState(b,d)),$('.table tr[data-id="'+b+'"]>td:last-child').text($("#edit-assignee option:selected").text()),a.ticketsModel.assigneeUserToTask(b,e),$("#edit").modal("hide")}deteleTicket(a){this.ticketsModel.deleteTicket(a)}addComment(a,b){this.ticketsModel.addComment(a,b),location.href="#/tickets/details/"+a,$("#container-comments").removeClass("hidden")}getTicketForCurrentUser(){let a=this.ticketsModel.getTicketForCurrentUser();return Promise.resolve(a)}deleteComment(a){this.ticketsModel.deleteComment(a)}searchTicketByTitle(a){let c,b=this;if(!a){let c=[],d=b._container[0].baseURI,e="/FindTiketsByTitle/:string";e=e.replace(/([:*])(\w+)/g,function(a,b,d){return c.push(d),"([^/]+)"})+"(?:/|$)",a=d.match(new RegExp(e))[1]}this.helpers.priorityHelper(),new loadTemplate("tickets-results").getTemplate().then(b=>{c=this.ticketsModel.searchTickets(a);return b}).then(a=>{setTimeout(function(){b.container.html(a(c))},1e3)})}}export{TicketsController};